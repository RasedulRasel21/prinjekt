{% comment %}
  Map – Locations (Google Maps)
  - Dynamic markers via blocks
  - Floating info card
  - Mobile/desktop heights
  - Requires Google Maps API key
{% endcomment %}

{%- comment -%} Section styles (external) {%- endcomment -%}
  {{ 'map-locations.css' | asset_url | stylesheet_tag }}

<section id="map-locations-{{ section.id }}" class="map-locations" data-section-id="{{ section.id }}">
  <div class="map-wrap">
    {% if section.settings.show_card %}
      <div class="info-card"
           style="--card-bg: {{ section.settings.card_bg | default: '#ffffff' }}; --card-text: {{ section.settings.card_text | default: '#111111' }};">
        {% if section.settings.card_title %}<h3>{{ section.settings.card_title }}</h3>{% endif %}
        {% if section.settings.card_subtitle %}<p class="subtitle">{{ section.settings.card_subtitle }}</p>{% endif %}
        {% if section.settings.rating_value != blank %}
          <div class="rating">
            <span class="star" aria-hidden="true"></span>
            <strong>{{ section.settings.rating_value }}</strong>
            {% if section.settings.rating_count %}<span>· {{ section.settings.rating_count }}</span>{% endif %}
          </div>
        {% endif %}
        {% if section.settings.cta_label and section.settings.cta_link %}
          <a class="cta"
             href="{{ section.settings.cta_link }}"
             target="{{ section.settings.cta_target | default: '_blank' | escape }}"
             style="--cta-bg: {{ section.settings.cta_bg | default: '#111111' }}; --cta-text: {{ section.settings.cta_text | default: '#ffffff' }};">
            {{ section.settings.cta_label }}
          </a>
        {% endif %}
      </div>
    {% endif %}

    <div id="google-map-{{ section.id }}"
         class="map{% if section.settings.grayscale %} map--gray{% endif %}"
         data-center-lat="{{ section.settings.center_lat | default: '52.319' }}"
         data-center-lng="{{ section.settings.center_lng | default: '9.722' }}"
         data-zoom="{{ section.settings.zoom | default: 14 }}"
         data-api-key="{{ section.settings.google_api_key }}"
         style="--map-height-desktop: {{ section.settings.height_desktop | default: 480 }}px;
                --map-height-mobile: {{ section.settings.height_mobile | default: 320 }}px;">
    </div>
  </div>

  <script>
    (function() {
      const sectionId = '{{ section.id }}';
      const el = document.getElementById('google-map-' + sectionId);
      if (!el) return;

      const apiKey = el.dataset.apiKey || el.getAttribute('data-api-key');
      
      if (!apiKey) {
        el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#f5f5f5;color:#666;font-size:14px;padding:20px;text-align:center;">Please add your Google Maps API key in the section settings</div>';
        return;
      }

      function initMap() {
        const center = {
          lat: parseFloat(el.dataset.centerLat || el.getAttribute('data-center-lat')),
          lng: parseFloat(el.dataset.centerLng || el.getAttribute('data-center-lng'))
        };
        const zoom = parseInt(el.dataset.zoom || el.getAttribute('data-zoom'), 10);

        const mapOptions = {
          center: center,
          zoom: zoom,
          disableDefaultUI: false,
          zoomControl: true,
          mapTypeControl: false,
          scaleControl: false,
          streetViewControl: false,
          rotateControl: false,
          fullscreenControl: true,
          gestureHandling: 'cooperative'
        };

        {% if section.settings.grayscale %}
        mapOptions.styles = [
          {
            elementType: "geometry",
            stylers: [{ color: "#f5f5f5" }]
          },
          {
            elementType: "labels.icon",
            stylers: [{ visibility: "off" }]
          },
          {
            elementType: "labels.text.fill",
            stylers: [{ color: "#616161" }]
          },
          {
            elementType: "labels.text.stroke",
            stylers: [{ color: "#f5f5f5" }]
          },
          {
            featureType: "administrative.land_parcel",
            elementType: "labels.text.fill",
            stylers: [{ color: "#bdbdbd" }]
          },
          {
            featureType: "poi",
            elementType: "geometry",
            stylers: [{ color: "#eeeeee" }]
          },
          {
            featureType: "poi",
            elementType: "labels.text.fill",
            stylers: [{ color: "#757575" }]
          },
          {
            featureType: "poi.park",
            elementType: "geometry",
            stylers: [{ color: "#e5e5e5" }]
          },
          {
            featureType: "poi.park",
            elementType: "labels.text.fill",
            stylers: [{ color: "#9e9e9e" }]
          },
          {
            featureType: "road",
            elementType: "geometry",
            stylers: [{ color: "#ffffff" }]
          },
          {
            featureType: "road.arterial",
            elementType: "labels.text.fill",
            stylers: [{ color: "#757575" }]
          },
          {
            featureType: "road.highway",
            elementType: "geometry",
            stylers: [{ color: "#dadada" }]
          },
          {
            featureType: "road.highway",
            elementType: "labels.text.fill",
            stylers: [{ color: "#616161" }]
          },
          {
            featureType: "road.local",
            elementType: "labels.text.fill",
            stylers: [{ color: "#9e9e9e" }]
          },
          {
            featureType: "transit.line",
            elementType: "geometry",
            stylers: [{ color: "#e5e5e5" }]
          },
          {
            featureType: "transit.station",
            elementType: "geometry",
            stylers: [{ color: "#eeeeee" }]
          },
          {
            featureType: "water",
            elementType: "geometry",
            stylers: [{ color: "#c9c9c9" }]
          },
          {
            featureType: "water",
            elementType: "labels.text.fill",
            stylers: [{ color: "#9e9e9e" }]
          }
        ];
        {% endif %}

        const map = new google.maps.Map(el, mapOptions);
        const bounds = new google.maps.LatLngBounds();
        const markers = [];

        {% for block in section.blocks %}
          {% if block.type == 'location' and block.settings.lat != blank and block.settings.lng != blank %}
            (function() {
              const lat = {{ block.settings.lat | replace: ',', '.' }};
              const lng = {{ block.settings.lng | replace: ',', '.' }};
              const position = { lat: lat, lng: lng };
              
              const marker = new google.maps.Marker({
                position: position,
                map: map,
                title: {{ block.settings.title | json }}
              });

              const title = {{ block.settings.title | json }};
              const addr  = {{ block.settings.address | json }};
              const linkLabel = {{ block.settings.link_label | json }};
              const linkUrl   = {{ block.settings.link_url | json }};

              let html = '<div class="popup">';
              if (title) html += '<h4>' + title + '</h4>';
              if (addr)  html += '<div class="address">' + addr + '</div>';
              {% if block.settings.popup_html != blank %}
                html += {{ block.settings.popup_html | json }};
              {% endif %}
              if (linkUrl && linkLabel) {
                html += '<a class="btn" href="' + linkUrl + '" target="_blank" rel="noopener">' + linkLabel + '</a>';
              }
              html += '</div>';

              const infoWindow = new google.maps.InfoWindow({
                content: html
              });

              marker.addListener('click', function() {
                infoWindow.open(map, marker);
              });

              markers.push(marker);
              bounds.extend(position);
            })();
          {% endif %}
        {% endfor %}

        if (markers.length > 1) {
          map.fitBounds(bounds);
          const padding = { top: 50, right: 50, bottom: 50, left: 50 };
          map.fitBounds(bounds, padding);
        }
      }

      // Load Google Maps API
      if (!window.googleMapsLoaded) {
        window.googleMapsLoaded = true;
        window.initGoogleMaps = function() {
          window.googleMapsReady = true;
          document.dispatchEvent(new Event('googleMapsReady'));
        };
        
        const script = document.createElement('script');
        script.src = 'https://maps.googleapis.com/maps/api/js?key=' + apiKey + '&callback=initGoogleMaps';
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
      }

      // Initialize map when Google Maps is ready
      if (window.googleMapsReady) {
        initMap();
      } else {
        document.addEventListener('googleMapsReady', initMap);
      }
    })();
  </script>

  {% schema %}
  {
    "name": "Map – Locations",
    "settings": [
      { "type": "paragraph", "content": "Add your Google Maps API key and locations below." },
      { "type": "text", "id": "google_api_key", "label": "Google Maps API Key", "info": "Get your API key from Google Cloud Console" },
      { "type": "text", "id": "center_lat", "label": "Initial center latitude", "default": "52.3190" },
      { "type": "text", "id": "center_lng", "label": "Initial center longitude", "default": "9.7220" },
      { "type": "range", "id": "zoom", "min": 3, "max": 20, "step": 1, "label": "Initial zoom", "default": 14 },

      { "type": "range", "id": "height_desktop", "min": 240, "max": 900, "step": 10, "label": "Height (desktop px)", "default": 480 },
      { "type": "range", "id": "height_mobile", "min": 180, "max": 700, "step": 10, "label": "Height (mobile px)", "default": 320 },
      { "type": "checkbox", "id": "grayscale", "label": "Grayscale map style", "default": false },

      { "type": "header", "content": "Floating card" },
      { "type": "checkbox", "id": "show_card", "label": "Show card", "default": true },
      { "type": "text", "id": "card_title", "label": "Card title", "default": "PrinjeKt – 3D-Druck Hannover" },
      { "type": "text", "id": "card_subtitle", "label": "Address / short note", "default": "Max-von-Laue-Straße 19, 30966 Hemmingen" },
      { "type": "text", "id": "rating_value", "label": "Rating value (e.g., 4.9)" },
      { "type": "text", "id": "rating_count", "label": "Rating count text (e.g., 24 reviews)" },
      { "type": "text", "id": "cta_label", "label": "CTA label", "default": "Routenplaner" },
      { "type": "url",  "id": "cta_link",  "label": "CTA link (leave blank to hide)" },
      { "type": "text", "id": "cta_target", "label": "CTA target", "default": "_blank", "info": "Usually _blank" },
      { "type": "color", "id": "card_bg", "label": "Card background", "default": "#ffffff" },
      { "type": "color", "id": "card_text", "label": "Card text", "default": "#111111" },
      { "type": "color", "id": "cta_bg", "label": "CTA background", "default": "#111111" },
      { "type": "color", "id": "cta_text", "label": "CTA text", "default": "#ffffff" }
    ],
    "blocks": [
      {
        "type": "location",
        "name": "Location",
        "settings": [
          { "type": "text", "id": "title", "label": "Title", "default": "Store / Location name" },
          { "type": "textarea", "id": "address", "label": "Address (shows in popup)" },
          { "type": "text", "id": "lat", "label": "Latitude", "default": "52.319" },
          { "type": "text", "id": "lng", "label": "Longitude", "default": "9.722" },
          { "type": "richtext", "id": "popup_html", "label": "Extra popup content (optional)" },
          { "type": "text", "id": "link_label", "label": "Popup button label", "default": "Directions" },
          { "type": "url",  "id": "link_url", "label": "Popup button link (optional)" }
        ]
      }
    ],
    "max_blocks": 20,
    "presets": [
      { "name": "Map – Locations", "category": "Map" }
    ]
  }
  {% endschema %}
</section>