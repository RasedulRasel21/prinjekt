{% comment %}
  Section: FAQ Accordion
  Files: sections/faq-accordion.liquid + assets/section-faq-accordion.css
{% endcomment %}

{{ 'section-faq-accordion.css' | asset_url | stylesheet_tag }}

<section id="faq-accordion-{{ section.id }}" class="faq-accordion-section">
  <div class="faq-accordion-wrap {% if section.settings.full_width == false %}page-width{% endif %}"
       style="--faq-accent: {{ section.settings.accent_color }}; --faq-bg: {{ section.settings.item_bg }}; --faq-radius: {{ section.settings.radius }}px; --faq-gap: {{ section.settings.gap }}px; --faq-shadow: {% if section.settings.shadow %}0 2px 10px rgba(0,0,0,.06){% else %}none{% endif %};">
    {% if section.settings.heading != blank %}
      <h2 class="faq-accordion-heading">{{ section.settings.heading }}</h2>
    {% endif %}

    <div class="faq-accordion" role="tablist" aria-multiselectable="false">
      {% for block in section.blocks %}
        {% assign b = block.settings %}
        {% assign item_id = 'faq-item-' | append: section.id | append: '-' | append: forloop.index %}

        <div class="faq-item" {{ block.shopify_attributes }} style="background: var(--faq-bg); border-radius: var(--faq-radius); box-shadow: var(--faq-shadow);">
          <button
            class="faq-trigger"
            id="{{ item_id }}-tab"
            type="button"
            role="tab"
            aria-controls="{{ item_id }}-panel"
            aria-expanded="{% if section.settings.open_first and forloop.first %}true{% else %}false{% endif %}">
            <span class="faq-icon" aria-hidden="true"></span>
            <span class="faq-question">{{ b.title | escape }}</span>
          </button>

          <div
            class="faq-panel"
            id="{{ item_id }}-panel"
            role="tabpanel"
            aria-labelledby="{{ item_id }}-tab"
            {% unless section.settings.open_first and forloop.first %}hidden{% endunless %}>
            <div class="faq-answer rte">
              {{ b.answer }}
            </div>

            {% if b.show_button and b.button_label != blank and b.button_url != blank %}
              <div class="faq-actions">
                <a
                  href="{{ b.button_url }}"
                  class="faq-btn {% if b.button_style == 'secondary' %}is-secondary{% endif %}"
                  {% if b.new_tab %}target="_blank" rel="noopener noreferrer"{% endif %}>
                  {{ b.button_label }}
                </a>
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <script>
    (function() {
      const root = document.getElementById('faq-accordion-{{ section.id }}');
      if (!root) return;

      const triggers = root.querySelectorAll('.faq-trigger');

      function closeAll(exceptBtn) {
        triggers.forEach(btn => {
          if (btn !== exceptBtn) {
            btn.setAttribute('aria-expanded', 'false');
            const panel = document.getElementById(btn.getAttribute('aria-controls'));
            if (panel && !panel.hasAttribute('hidden')) panel.setAttribute('hidden', '');
          }
        });
      }

      triggers.forEach(btn => {
        btn.addEventListener('click', () => {
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          const panel = document.getElementById(btn.getAttribute('aria-controls'));

          // close others first
          closeAll(btn);

          if (expanded) {
            // close current
            btn.setAttribute('aria-expanded', 'false');
            panel.setAttribute('hidden', '');
          } else {
            // open current
            btn.setAttribute('aria-expanded', 'true');
            panel.removeAttribute('hidden');
          }
        });
      });
    })();
  </script>
</section>

{% schema %}
{
  "name": "FAQ Accordion",
  "tag": "section",
  "class": "section",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "FAQ" },
    { "type": "checkbox", "id": "full_width", "label": "Full width", "default": false },
    { "type": "checkbox", "id": "open_first", "label": "Open first item by default", "default": true },
    { "type": "color", "id": "accent_color", "label": "Accent color", "default": "#f4a261" },
    { "type": "color", "id": "item_bg", "label": "Item background", "default": "#ffffff" },
    { "type": "range", "id": "radius", "min": 0, "max": 24, "step": 1, "unit": "px", "label": "Corner radius", "default": 12 },
    { "type": "range", "id": "gap", "min": 4, "max": 28, "step": 2, "unit": "px", "label": "Items gap", "default": 12 },
    { "type": "checkbox", "id": "shadow", "label": "Light shadow", "default": true }
  ],
  "blocks": [
    {
      "type": "faq_item",
      "name": "FAQ item",
      "settings": [
        { "type": "text", "id": "title", "label": "Question", "default": "Was ist Prinkjet?" },
        { "type": "richtext", "id": "answer", "label": "Answer", "default": "<p>Ihre Antwort kommt hier.</p>" },
        { "type": "checkbox", "id": "show_button", "label": "Show button", "default": false },
        { "type": "text", "id": "button_label", "label": "Button label", "default": "Mehr erfahren" },
        { "type": "url", "id": "button_url", "label": "Button link" },
        { "type": "select", "id": "button_style", "label": "Button style", "default": "primary", "options": [
          { "value": "primary", "label": "Primary" },
          { "value": "secondary", "label": "Secondary" }
        ]},
        { "type": "checkbox", "id": "new_tab", "label": "Open in new tab", "default": false }
      ]
    }
  ],
  "max_blocks": 20,
  "presets": [
    { "name": "FAQ Accordion", "category": "Text" }
  ]
}
{% endschema %}

{% stylesheet %}
{% endstylesheet %}

{% javascript %}
{% endjavascript %}
